{%- if block.settings.embed_enabled -%}
<script>
  // Enhanced script loading with better error handling
  (function loadVisualSearchScript() {
    // Check if script is already loaded or loading
    if (window.visualSearchUnified) {
      console.log('[Visual Search Embed] ‚úÖ Script already available');
      return;
    }
    
    // Check if script is already being loaded
    if (document.querySelector('script[src*="visual-search-unified-backup-without-search-selector"]')) {
      console.log('[Visual Search Embed] üîÑ Script already loading...');
      return;
    }
    
    console.log('[Visual Search Embed] üì• Loading main script...');
    const visualSearchScript = document.createElement('script');
    visualSearchScript.src = "{{ 'visual-search-unified-backup-without-search-selector.js' | asset_url }}";
    visualSearchScript.async = true;
    
    visualSearchScript.onload = function() {
      console.log('[Visual Search Embed] ‚úÖ Main script loaded successfully');
    };
    
    visualSearchScript.onerror = function() {
      console.error('[Visual Search Embed] ‚ùå Failed to load main script from:', this.src);
    };
    
    document.head.appendChild(visualSearchScript);
  })();
</script>

<style>
  .vs-enhanced-search-container {
    position: relative;
    display: inline-block;
    width: 100%;
  }
  
  .vs-search-icon {
    position: absolute;
    top: 50%;
    right: {{ block.settings.icon_margin | default: 8 }}px;
    transform: translateY(-50%);
    cursor: pointer;
    color: {{ block.settings.icon_color | default: '#5f6368' }};
    background-color: {{ block.settings.icon_background | default: 'transparent' }};
    transition: all 0.2s ease;
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: auto;
    padding: 4px;
    border-radius: 4px;
    width: {{ block.settings.icon_size | default: 34 }}px;
    height: {{ block.settings.icon_size | default: 34 }}px;
  }
  
  .vs-search-icon:hover {
    opacity: 0.8;
    background-color: rgba(0, 0, 0, 0.05);
  }
  
  .vs-search-icon.vs-loading {
    opacity: 0.6;
    animation: vs-pulse 1s infinite;
  }
  
  @keyframes vs-pulse {
    0%, 100% { opacity: 0.6; }
    50% { opacity: 0.8; }
  }
</style>

<script>
(function() {
  'use strict';
  
  const config = {
    blockId: '{{ block.id }}',
    shopDomain: '{{ shop.permanent_domain }}',
    appUrl: 'https://programmers-acre-clip-foo.trycloudflare.com',
    settings: {
      embedEnabled: {{ block.settings.embed_enabled | default: true }},
      iconSize: {{ block.settings.icon_size | default: 34 }},
      iconMargin: {{ block.settings.icon_margin | default: 8 }},
      advancedSettings: '{{ block.settings.custom_settings | default: "" }}'
    }
  };
  
  // Parse advanced settings
  function parseAdvancedSettings(settingsString) {
    const settings = { customIconUrl: '', customSelector: '' };
    if (!settingsString) return settings;
    
    const pairs = settingsString.split('|');
    pairs.forEach(pair => {
      const [key, value] = pair.split(':');
      if (key && value !== undefined) {
        if (key.trim() === 'icon_url' && value.trim()) {
          settings.customIconUrl = value.trim();
        } else if (key.trim() === 'selectors' && value.trim()) {
          settings.customSelector = value.trim();
        }
      }
    });
    return settings;
  }
  
  const advancedSettings = parseAdvancedSettings(config.settings.advancedSettings);
  
  if (!config.settings.embedEnabled) {
    console.log('[Visual Search Embed] üö´ Embed disabled via settings');
    return;
  }

  // Load the main script immediately (same method as floating block)
  const visualSearchScript = document.createElement('script');
  visualSearchScript.src = "{{ 'visual-search-unified-backup-without-search-selector.js' | asset_url }}";
  document.head.appendChild(visualSearchScript);

  function waitForMainScript() {
    console.log('[Visual Search Embed] ‚è≥ Waiting for main visual search script...');
    
    // Check if main script is loaded every 500ms, max 40 attempts (20 seconds)
    let attempts = 0;
    const maxAttempts = 40;
    
    const checkScript = setInterval(() => {
      attempts++;
      
      if (window.visualSearchUnified || attempts >= maxAttempts) {
        clearInterval(checkScript);
        
        if (window.visualSearchUnified) {
          console.log('[Visual Search Embed] ‚úÖ Main script found, initializing embed...');
          console.log('[Visual Search Embed] üîç Available methods:', Object.keys(window.visualSearchUnified));
          initializeEmbedEnhancer();
        } else {
          console.warn('[Visual Search Embed] ‚ö†Ô∏è Main script not found after 20 seconds, proceeding anyway...');
          console.log('[Visual Search Embed] üîç window.visualSearchUnified:', window.visualSearchUnified);
          initializeEmbedEnhancer();
        }
      } else if (attempts % 5 === 0) {
        console.log(`[Visual Search Embed] üîÑ Still waiting for script... attempt ${attempts}/${maxAttempts}`);
      }
    }, 500);
  }
  
  function initializeEmbedEnhancer() {
    console.log('[Visual Search Embed] üéØ Starting search input detection...');
    
    // Universal search selectors for common themes
    const searchSelectors = [
      // Custom selectors from merchant settings (highest priority)
      ...(advancedSettings.customSelector ? advancedSettings.customSelector.split(',').map(s => s.trim()).filter(s => s) : []),
      
      // Standard selectors
      'input[name="q"]',
      'input[name="search"]',
      'input[type="search"]',
      'input[placeholder*="Search" i]',
      'input[placeholder*="search" i]',
      'input[aria-label*="Search" i]',
      'input[aria-label*="search" i]',
      
      // Theme-specific selectors
      '.search-bar input',
      '.search__input',
      '.header__search input',
      '.predictive-search__input',
      '.search-modal input',
      '#SearchInput',
      '#SearchDrawer input',
      '.drawer__search input',
      '.search-form input',
      '.searchbox input',
      
      // Dawn theme specific
      '.header__search-input',
      '.search-modal__form input',
      '.predictive-search-input',
      
      // Debut theme specific
      '.search-bar__input',
      '.site-header__search-input',
      
      // Brooklyn theme specific
      '.search__terms',
      '.search-bar__terms'
    ];
    
    function detectAndEnhanceSearchInputs() {
      const allInputs = document.querySelectorAll(searchSelectors.join(', '));
      let enhancedCount = 0;
      
      console.log(`[Visual Search Embed] üîç Found ${allInputs.length} potential search inputs`);
      
      allInputs.forEach((input, index) => {
        if (shouldEnhanceInput(input)) {
          enhanceSearchInputForEmbed(input, config, index);
          enhancedCount++;
        }
      });
      
      console.log(`[Visual Search Embed] ‚ú® Enhanced ${enhancedCount} search inputs`);
      
      // Provide helpful suggestions if no inputs were enhanced
      if (enhancedCount === 0) {
        console.group('[Visual Search Embed] üí° No search inputs found - Here are some suggestions:');
        
        if (config.settings.advancedSettings) {
          console.log('‚ùå Your custom selector didn\'t match any elements:', advancedSettings.customSelector);
          console.log('   Please check the selector syntax and try again.');
        } else {
          console.log('üîß Try adding custom selectors in Theme Settings > App Embeds > Visual Search');
        }
        
        // Suggest potential search inputs
        console.log('üîç Potential search inputs found on this page:');
        const potentialInputs = document.querySelectorAll('input');
        let suggestionCount = 0;
        
        potentialInputs.forEach((input, i) => {
          if (input.type === 'text' || input.type === 'search' || 
              input.placeholder?.toLowerCase().includes('search') ||
              input.name?.toLowerCase().includes('search') ||
              input.id?.toLowerCase().includes('search')) {
            suggestionCount++;
            const suggestions = [];
            if (input.name) suggestions.push(`input[name="${input.name}"]`);
            if (input.id) suggestions.push(`#${input.id}`);
            if (input.className) suggestions.push(`.${input.className.split(' ').join('.')}`);
            
            console.log(`   ${suggestionCount}. ${suggestions.join(' or ')}`);
            if (input.placeholder) console.log(`      Placeholder: "${input.placeholder}"`);
          }
        });
        
        if (suggestionCount === 0) {
          console.log('   No obvious search inputs found. The search might be loaded dynamically.');
        } else {
          console.log('üìù Copy one of the selectors above and paste it in Theme Settings > App Embeds > Visual Search > Custom Search Selectors');
        }
        
        console.groupEnd();
      }
    }
    
    function shouldEnhanceInput(input) {
      return input && 
             isElementVisible(input) && 
             !input.hasAttribute('data-vs-enhanced-{{ block.id }}');
    }
    
    function enhanceSearchInputForEmbed(input, config, index) {
      console.log('[Visual Search Embed] üé® Enhancing search input:', {
        element: input,
        type: input.type,
        name: input.name,
        id: input.id,
        className: input.className,
        placeholder: input.placeholder
      });
      
      // Mark as enhanced for this specific embed
      input.setAttribute('data-vs-enhanced-{{ block.id }}', 'true');
      
      // Create container wrapper only if it doesn't exist
      let container = input.closest('.vs-enhanced-search-container');
      if (!container) {
        container = document.createElement('div');
        container.className = 'vs-enhanced-search-container';
        container.setAttribute('data-vs-embed', '{{ block.id }}');
        
        // Wrap the input
        input.parentNode.insertBefore(container, input);
        container.appendChild(input);
        
        console.log('[Visual Search Embed] üì¶ Created container wrapper for input');
      }
      
      // Create visual search icon
      const icon = createSearchIcon(config, index);
      container.appendChild(icon);
      
      console.log('[Visual Search Embed] ‚úÖ Search input successfully enhanced with visual search icon');
    }
    
    function createSearchIcon(config, index) {
      const settings = config.settings;
      const icon = document.createElement('div');
      
      icon.className = 'vs-search-icon';
      icon.setAttribute('data-vs-trigger', 'embed-{{ block.id }}');
      icon.setAttribute('data-vs-input-index', index);
      
      // Add icon (custom image or default SVG)
      if (advancedSettings.customIconUrl && advancedSettings.customIconUrl.trim()) {
        icon.innerHTML = `<img src="${advancedSettings.customIconUrl}" alt="Visual Search" style="width: ${settings.iconSize}px; height: ${settings.iconSize}px; object-fit: contain;" />`;
      } else {
        icon.innerHTML = `
          <svg width="${settings.iconSize}" height="${settings.iconSize}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/>
            <circle cx="12" cy="13" r="3"/>
          </svg>
        `;
      }
      
      // Add click handler - integrates with your existing system
      icon.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        // Show loading state
        icon.classList.add('vs-loading');
        
        // Find the associated search input
        const searchInput = icon.closest('.vs-enhanced-search-container').querySelector('input');
        
        // Use the existing visual search system
        if (window.visualSearchUnified && window.visualSearchUnified.openDrawer) {
          console.log('[Visual Search Embed] üöÄ Opening visual search drawer for input:', searchInput);
          window.visualSearchUnified.openDrawer(searchInput);
        } else {
          console.error('[Visual Search Embed] ‚ùå visualSearchUnified.openDrawer not available');
          console.log('[Visual Search Embed] üîß Attempting to reload script...');
          
          // Try loading the script again and retry
          const retryScript = document.createElement('script');
          retryScript.src = "{{ 'visual-search-unified-backup-without-search-selector.js' | asset_url }}";
          retryScript.onload = function() {
            setTimeout(() => {
              if (window.visualSearchUnified && window.visualSearchUnified.openDrawer) {
                console.log('[Visual Search Embed] ‚úÖ Retry successful, opening drawer...');
                window.visualSearchUnified.openDrawer(searchInput);
              } else {
                console.error('[Visual Search Embed] ‚ùå Retry failed - script still not available');
              }
            }, 1000);
          };
          document.head.appendChild(retryScript);
        }
        
        // Restore icon after delay
        setTimeout(() => {
          icon.classList.remove('vs-loading');
        }, 1000);
        
        // Track usage
        trackEmbedUsage('icon_clicked', {
          embedId: config.blockId,
          inputIndex: index,
          inputType: searchInput.type,
          inputName: searchInput.name
        });
      });
      
      return icon;
    }
    
    function isElementVisible(element) {
      const style = window.getComputedStyle(element);
      return style.display !== 'none' && 
             style.visibility !== 'hidden' && 
             style.opacity !== '0' &&
             element.offsetWidth > 0 && 
             element.offsetHeight > 0;
    }
    
    function trackEmbedUsage(action, metadata = {}) {
      try {
        console.log('[Visual Search Embed] üìä Track:', action, metadata);
        // Add actual analytics here if needed
      } catch (e) {
        // Silent fail
      }
    }
    
    // Initialize enhancement
    detectAndEnhanceSearchInputs();
    
    // Re-enhance on DOM changes (for AJAX/SPA themes)
    const observer = new MutationObserver(() => {
      setTimeout(detectAndEnhanceSearchInputs, 100);
    });
    
    observer.observe(document.body, {
      childList: true,
      subtree: true
    });
    
    // Re-enhance on Shopify theme events
    const shopifyEvents = [
      'shopify:section:load',
      'shopify:section:reorder',
      'theme:header:search:opened',
      'predictive-search:open'
    ];
    
    shopifyEvents.forEach(event => {
      document.addEventListener(event, () => {
        setTimeout(detectAndEnhanceSearchInputs, 200);
      });
    });
    
    console.log('[Visual Search Embed] ‚úÖ Embed enhancer initialization complete');
  }
  
  // Start initialization
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', waitForMainScript);
  } else {
    waitForMainScript();
  }
  
})();
</script>
{%- endif -%}

{% schema %}
{
  "name": "Visual Search Input",
  "target": "head",
  "settings": [
    {
      "type": "checkbox",
      "id": "embed_enabled",
      "label": "Enable Visual Search",
      "default": true
    },
    {
      "type": "range",
      "id": "icon_size",
      "label": "Icon Size",
      "min": 16,
      "max": 48,
      "step": 2,
      "default": 34,
      "unit": "px"
    },
    {
      "type": "color",
      "id": "icon_color",
      "label": "Icon Color",
      "default": "#5f6368"
    },
    {
      "type": "color",
      "id": "icon_background",
      "label": "Icon Background Color",
      "default": "transparent"
    },
    {
      "type": "text",
      "id": "custom_settings",
      "label": "Advanced Settings",
      "default": "icon_url:|selectors:",
      "info": "Format: icon_url:https://example.com/icon.png|selectors:input[name='q'],.search-input (separate with | and use : for values)"
    },
    {
      "type": "range",
      "id": "icon_margin",
      "label": "Icon Margin from Edge",
      "min": 4,
      "max": 100,
      "step": 2,
      "default": 8,
      "unit": "px"
    }
  ]
}
{% endschema %}
